_format_version: "3.0"
_transform: true

services:
  - name: auth-service
    url: http://auth-service:8001
    routes:
      - name: auth-route
        paths:
          - /api/v1/auth
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 60
          policy: local
      - name: jwt
        config:
          claims_to_verify:
            - exp

  - name: script-service
    url: http://script-service:8002
    routes:
      - name: script-route
        paths:
          - /api/v1/scripts
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 120
          policy: local

  - name: execution-service
    url: http://execution-service:8003
    routes:
      - name: execution-route
        paths:
          - /api/v1/executions
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 30
          policy: local

  - name: secret-service
    url: http://secret-service:8004
    routes:
      - name: secret-route
        paths:
          - /api/v1/secrets
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 60
          policy: local

plugins:
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true

  - name: request-transformer
    config:
      add:
        headers:
          - "X-Gateway: kong"

  - name: response-transformer
    config:
      add:
        headers:
          - "X-Frame-Options: SAMEORIGIN"
          - "X-Content-Type-Options: nosniff"
          - "X-XSS-Protection: 1; mode=block"

  - name: prometheus
    config:
      per_consumer: false

  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
      exposed_headers:
        - X-Correlation-ID
      credentials: true
      max_age: 3600
