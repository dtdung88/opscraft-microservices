events {
    worker_connections 1024;
}

http {
    upstream auth_service {
        server auth-service:8001;
    }

    upstream script_service {
        server script-service:8002;
    }

    upstream execution_service {
        server execution-service:8003;
    }

    upstream secret_service {
        server secret-service:8004;
    }

    upstream admin_service {
        server admin-service:8005;
    }

    server {
        listen 8000;

        # Auth Service
        location /api/v1/auth {
            proxy_pass http://auth_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Script Service
        location /api/v1/scripts {
            proxy_pass http://script_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Execution Service
        location /api/v1/executions {
            proxy_pass http://execution_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # WebSocket
        location /ws {
            proxy_pass http://execution_service;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Secret Service
        location /api/v1/secrets {
            proxy_pass http://secret_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Admin Service
        location /api/v1/admin {
            proxy_pass http://admin_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Health Check
        location /health {
            return 200 '{"status":"healthy","service":"api-gateway"}';
            add_header Content-Type application/json;
        }
    }
}
