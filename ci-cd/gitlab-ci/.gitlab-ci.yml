stages:
  - lint
  - test
  - security
  - build
  - deploy-staging
  - integration-tests
  - deploy-production

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY: registry.gitlab.com
  IMAGE_BASE: $CI_REGISTRY/$CI_PROJECT_PATH

.python-template: &python-template
  image: python:3.12-slim
  before_script:
    - pip install --upgrade pip
    - pip install ruff pytest pytest-cov pytest-asyncio httpx

.docker-template: &docker-template
  image: docker:24.0
  services:
    - docker:24.0-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# ============================================================================
# LINT STAGE
# ============================================================================
lint:auth-service:
  <<: *python-template
  stage: lint
  script:
    - cd services/auth-service
    - pip install ruff
    - ruff check . --output-format=gitlab
    - ruff format --check .
  rules:
    - changes:
        - services/auth-service/**/*
        - shared/**/*

lint:script-service:
  <<: *python-template
  stage: lint
  script:
    - cd services/script-service
    - pip install ruff
    - ruff check . --output-format=gitlab
    - ruff format --check .
  rules:
    - changes:
        - services/script-service/**/*
        - shared/**/*

lint:execution-service:
  <<: *python-template
  stage: lint
  script:
    - cd services/execution-service
    - pip install ruff
    - ruff check . --output-format=gitlab
    - ruff format --check .
  rules:
    - changes:
        - services/execution-service/**/*
        - shared/**/*

lint:secret-service:
  <<: *python-template
  stage: lint
  script:
    - cd services/secret-service
    - pip install ruff
    - ruff check . --output-format=gitlab
    - ruff format --check .
  rules:
    - changes:
        - services/secret-service/**/*
        - shared/**/*

# ============================================================================
# TEST STAGE
# ============================================================================
.test-template: &test-template
  <<: *python-template
  stage: test
  services:
    - postgres:15-alpine
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: postgresql://postgres:postgres@postgres:5432/test_db
    REDIS_URL: redis://redis:6379/0
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

test:auth-service:
  <<: *test-template
  variables:
    SECRET_KEY: test-secret-key-for-ci-testing-min-32
  script:
    - cd services/auth-service
    - pip install -r requirements.txt
    - pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
  rules:
    - changes:
        - services/auth-service/**/*

test:script-service:
  <<: *test-template
  script:
    - cd services/script-service
    - pip install -r requirements.txt
    - pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
  rules:
    - changes:
        - services/script-service/**/*

test:execution-service:
  <<: *test-template
  variables:
    CELERY_BROKER_URL: redis://redis:6379/5
    CELERY_RESULT_BACKEND: redis://redis:6379/6
  script:
    - cd services/execution-service
    - pip install -r requirements.txt
    - pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
  rules:
    - changes:
        - services/execution-service/**/*

test:secret-service:
  <<: *test-template
  variables:
    ENCRYPTION_KEY: test-encryption-key-32-characters!
  script:
    - cd services/secret-service
    - pip install -r requirements.txt
    - pytest tests/ -v --cov=app --cov-report=xml --cov-report=term
  rules:
    - changes:
        - services/secret-service/**/*

# ============================================================================
# SECURITY STAGE
# ============================================================================
security:sast:
  stage: security
  image: python:3.12-slim
  script:
    - pip install bandit safety
    - bandit -r services/ -ll -ii -f json -o bandit-report.json || true
    - safety check --json > safety-report.json || true
  artifacts:
    reports:
      sast: bandit-report.json
    paths:
      - bandit-report.json
      - safety-report.json
  allow_failure: true

security:container-scan:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy fs --format json --output trivy-report.json services/
  artifacts:
    paths:
      - trivy-report.json
  allow_failure: true

security:secrets-scan:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json
  artifacts:
    paths:
      - gitleaks-report.json
  allow_failure: true

# ============================================================================
# BUILD STAGE
# ============================================================================
.build-template: &build-template
  <<: *docker-template
  stage: build
  script:
    - docker build -t $IMAGE_BASE/$SERVICE_NAME:$CI_COMMIT_SHA -t $IMAGE_BASE/$SERVICE_NAME:latest ./services/$SERVICE_NAME
    - docker push $IMAGE_BASE/$SERVICE_NAME:$CI_COMMIT_SHA
    - docker push $IMAGE_BASE/$SERVICE_NAME:latest

build:auth-service:
  <<: *build-template
  variables:
    SERVICE_NAME: auth-service
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/auth-service/**/*

build:script-service:
  <<: *build-template
  variables:
    SERVICE_NAME: script-service
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/script-service/**/*

build:execution-service:
  <<: *build-template
  variables:
    SERVICE_NAME: execution-service
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/execution-service/**/*

build:secret-service:
  <<: *build-template
  variables:
    SERVICE_NAME: secret-service
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
      changes:
        - services/secret-service/**/*

# ============================================================================
# DEPLOY STAGING
# ============================================================================
deploy:staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  environment:
    name: staging
    url: https://staging.opscraft.example.com
  script:
    - kubectl config set-cluster k8s --server=$KUBE_SERVER --certificate-authority=$KUBE_CA_CERT
    - kubectl config set-credentials gitlab --token=$KUBE_TOKEN
    - kubectl config set-context default --cluster=k8s --user=gitlab --namespace=opscraft-staging
    - kubectl config use-context default
    - kubectl apply -f k8s/ -n opscraft-staging
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - build:auth-service
    - build:script-service
    - build:execution-service
    - build:secret-service

# ============================================================================
# INTEGRATION TESTS
# ============================================================================
integration-tests:
  stage: integration-tests
  image: python:3.12-slim
  script:
    - pip install pytest httpx pytest-asyncio
    - pytest tests/integration/ -v
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  needs:
    - deploy:staging

# ============================================================================
# DEPLOY PRODUCTION
# ============================================================================
deploy:production:
  stage: deploy-production
  image: bitnami/kubectl:latest
  environment:
    name: production
    url: https://opscraft.example.com
  script:
    - kubectl config set-cluster k8s --server=$KUBE_SERVER --certificate-authority=$KUBE_CA_CERT
    - kubectl config set-credentials gitlab --token=$KUBE_TOKEN
    - kubectl config set-context default --cluster=k8s --user=gitlab --namespace=opscraft
    - kubectl config use-context default
    - kubectl apply -f k8s/ -n opscraft
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
  needs:
    - build:auth-service
    - build:script-service
    - build:execution-service
    - build:secret-service
