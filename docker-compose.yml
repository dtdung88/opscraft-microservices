networks:
  opscraft-network:
    driver: bridge

volumes:
  postgres-auth:
  postgres-script:
  postgres-execution:
  postgres-secret:
  postgres-scheduler:
  postgres-approval:
  postgres-audit:
  redis-data:
  kafka-data:
  zookeeper-data:

services:
  # Infrastructure
  auth-db:
    image: postgres:15-alpine
    container_name: auth-db
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-auth:/var/lib/postgresql/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  script-db:
    image: postgres:15-alpine
    container_name: script-db
    environment:
      POSTGRES_DB: script_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-script:/var/lib/postgresql/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  execution-db:
    image: postgres:15-alpine
    container_name: execution-db
    environment:
      POSTGRES_DB: execution_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-execution:/var/lib/postgresql/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  secret-db:
    image: postgres:15-alpine
    container_name: secret-db
    environment:
      POSTGRES_DB: secret_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-secret:/var/lib/postgresql/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  scheduler-db:
    image: postgres:15-alpine
    container_name: scheduler-db
    environment:
      POSTGRES_DB: scheduler_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-scheduler:/var/lib/postgresql/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  approval-db:
    image: postgres:15-alpine
    container_name: approval-db
    environment:
      POSTGRES_DB: approval_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-approval:/var/lib/postgresql/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  audit-db:
    image: postgres:15-alpine
    container_name: audit-db
    environment:
      POSTGRES_DB: audit_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-audit:/var/lib/postgresql/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: opscraft-redis
    volumes:
      - redis-data:/data
    networks:
      - opscraft-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
    networks:
      - opscraft-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - opscraft-network
    healthcheck:
      test:
        [
          "CMD",
          "kafka-broker-api-versions",
          "--bootstrap-server",
          "localhost:9092",
        ]
      interval: 10s
      timeout: 10s
      retries: 5

  # Core Services
  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    environment:
      DATABASE_URL: postgresql://postgres:postgres@auth-db:5432/auth_db
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SECRET_KEY: ${SECRET_KEY}
    ports:
      - "8001:8001"
    depends_on:
      auth-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - opscraft-network
    restart: unless-stopped

  script-service:
    build: ./services/script-service
    container_name: script-service
    environment:
      DATABASE_URL: postgresql://postgres:postgres@script-db:5432/script_db
      REDIS_URL: redis://redis:6379/1
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      AUTH_SERVICE_URL: http://auth-service:8001
    ports:
      - "8002:8002"
    depends_on:
      script-db:
        condition: service_healthy
      auth-service:
        condition: service_started
    networks:
      - opscraft-network
    restart: unless-stopped

  execution-service:
    build: ./services/execution-service
    container_name: execution-service
    environment:
      DATABASE_URL: postgresql://postgres:postgres@execution-db:5432/execution_db
      REDIS_URL: redis://redis:6379/2
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      CELERY_BROKER_URL: redis://redis:6379/5
      CELERY_RESULT_BACKEND: redis://redis:6379/5
    ports:
      - "8003:8003"
    depends_on:
      execution-db:
        condition: service_healthy
    networks:
      - opscraft-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  execution-worker:
    build: ./services/execution-service
    container_name: execution-worker
    command: celery -A app.workers.celery_worker:celery_app worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://postgres:postgres@execution-db:5432/execution_db
      REDIS_URL: redis://redis:6379/2
      CELERY_BROKER_URL: redis://redis:6379/5
    depends_on:
      - redis
      - execution-db
    networks:
      - opscraft-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  secret-service:
    build: ./services/secret-service
    container_name: secret-service
    environment:
      DATABASE_URL: postgresql://postgres:postgres@secret-db:5432/secret_db
      REDIS_URL: redis://redis:6379/3
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
    ports:
      - "8004:8004"
    depends_on:
      secret-db:
        condition: service_healthy
    networks:
      - opscraft-network
    restart: unless-stopped

  notification-service:
    build: ./services/notification-service
    container_name: notification-service
    environment:
      REDIS_URL: redis://redis:6379/4
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
      - "8005:8005"
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - opscraft-network
    restart: unless-stopped

  admin-service:
    build: ./services/admin-service
    container_name: admin-service
    environment:
      AUTH_SERVICE_URL: http://auth-service:8001
      SCRIPT_SERVICE_URL: http://script-service:8002
      EXECUTION_SERVICE_URL: http://execution-service:8003
      SECRET_SERVICE_URL: http://secret-service:8004
    ports:
      - "8006:8006"
    depends_on:
      - auth-service
    networks:
      - opscraft-network
    restart: unless-stopped

  # Advanced Services
  scheduler-service:
    build: ./services/scheduler-service
    container_name: scheduler-service
    environment:
      DATABASE_URL: postgresql://postgres:postgres@scheduler-db:5432/scheduler_db
      REDIS_URL: redis://redis:6379/6
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      EXECUTION_SERVICE_URL: http://execution-service:8003
    ports:
      - "8007:8007"
    depends_on:
      scheduler-db:
        condition: service_healthy
    networks:
      - opscraft-network
    restart: unless-stopped

  approval-service:
    build: ./services/approval-service
    container_name: approval-service
    environment:
      DATABASE_URL: postgresql://postgres:postgres@approval-db:5432/approval_db
      REDIS_URL: redis://redis:6379/7
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
      - "8008:8008"
    depends_on:
      approval-db:
        condition: service_healthy
    networks:
      - opscraft-network
    restart: unless-stopped

  audit-service:
    build: ./services/audit-service
    container_name: audit-service
    environment:
      DATABASE_URL: postgresql://postgres:postgres@audit-db:5432/audit_db
      REDIS_URL: redis://redis:6379/8
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    ports:
      - "8009:8009"
    depends_on:
      audit-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - opscraft-network
    restart: unless-stopped

  backup-service:
    build: ./services/backup-service
    container_name: backup-service
    environment:
      AUTH_DB_URL: postgresql://postgres:postgres@auth-db:5432/auth_db
      SCRIPT_DB_URL: postgresql://postgres:postgres@script-db:5432/script_db
      EXECUTION_DB_URL: postgresql://postgres:postgres@execution-db:5432/execution_db
      SECRET_DB_URL: postgresql://postgres:postgres@secret-db:5432/secret_db
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    ports:
      - "8010:8010"
    networks:
      - opscraft-network
    restart: unless-stopped

  # API Gateway
  api-gateway:
    image: nginx:alpine
    container_name: api-gateway
    ports:
      - "8000:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./gateway/proxy_params:/etc/nginx/proxy_params:ro
    depends_on:
      - auth-service
      - script-service
      - execution-service
      - secret-service
      - notification-service
      - admin-service
      - scheduler-service
      - approval-service
      - audit-service
    networks:
      - opscraft-network
    restart: unless-stopped

  # Frontend
  frontend:
    build: ./frontend
    container_name: opscraft-frontend
    environment:
      REACT_APP_API_URL: http://localhost:8000/api/v1
      REACT_APP_WS_URL: ws://localhost:8000/ws
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - opscraft-network
    restart: unless-stopped
