# Makefile - OpsCraft Development & CI/CD Commands

.PHONY: help install dev test lint format security clean docker-build docker-up docker-down

# Colors for output
BLUE := \033[0;34m
GREEN := \033[0;32m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## Show this help message
	@echo "$(BLUE)OpsCraft - Available Commands:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

# Installation & Setup
install: ## Install all dependencies
	@echo "$(BLUE)Installing dependencies...$(NC)"
	poetry install
	pre-commit install

install-prod: ## Install production dependencies only
	@echo "$(BLUE)Installing production dependencies...$(NC)"
	poetry install --no-dev

dev: ## Setup development environment
	@echo "$(BLUE)Setting up development environment...$(NC)"
	cp .env.example .env
	make install
	make db-init

# Code Quality
format: ## Format code with black and isort
	@echo "$(BLUE)Formatting code...$(NC)"
	poetry run black .
	poetry run isort .

lint: ## Run all linters
	@echo "$(BLUE)Running linters...$(NC)"
	poetry run black --check .
	poetry run isort --check-only .
	poetry run flake8 .
	poetry run pylint shared/ services/*/app/
	poetry run mypy .

type-check: ## Run type checking
	@echo "$(BLUE)Running type checker...$(NC)"
	poetry run mypy .

security: ## Run security checks
	@echo "$(BLUE)Running security checks...$(NC)"
	poetry run bandit -r . -c pyproject.toml
	poetry run safety check --json

pre-commit: ## Run pre-commit hooks
	@echo "$(BLUE)Running pre-commit hooks...$(NC)"
	poetry run pre-commit run --all-files

# Testing
test: ## Run all tests
	@echo "$(BLUE)Running tests...$(NC)"
	poetry run pytest

test-unit: ## Run unit tests only
	@echo "$(BLUE)Running unit tests...$(NC)"
	poetry run pytest -m unit

test-integration: ## Run integration tests only
	@echo "$(BLUE)Running integration tests...$(NC)"
	poetry run pytest -m integration

test-e2e: ## Run end-to-end tests
	@echo "$(BLUE)Running e2e tests...$(NC)"
	poetry run pytest -m e2e

test-cov: ## Run tests with coverage report
	@echo "$(BLUE)Running tests with coverage...$(NC)"
	poetry run pytest --cov=. --cov-report=html --cov-report=term

# Database
db-init: ## Initialize database
	@echo "$(BLUE)Initializing database...$(NC)"
	docker-compose up -d postgres redis
	sleep 5
	alembic upgrade head

db-migrate: ## Create new migration
	@echo "$(BLUE)Creating migration...$(NC)"
	@read -p "Enter migration message: " msg; \
	alembic revision --autogenerate -m "$$msg"

db-upgrade: ## Upgrade database to latest
	@echo "$(BLUE)Upgrading database...$(NC)"
	alembic upgrade head

db-downgrade: ## Downgrade database by one revision
	@echo "$(BLUE)Downgrading database...$(NC)"
	alembic downgrade -1

db-reset: ## Reset database (DANGER!)
	@echo "$(RED)WARNING: This will delete all data!$(NC)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose down -v; \
		docker-compose up -d postgres redis; \
		sleep 5; \
		alembic upgrade head; \
	fi

# Docker
docker-build: ## Build all Docker images
	@echo "$(BLUE)Building Docker images...$(NC)"
	docker-compose build

docker-up: ## Start all services
	@echo "$(BLUE)Starting services...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)Services started!$(NC)"
	@echo "API Gateway: http://localhost:8080"
	@echo "Monitoring: http://localhost:9090"

docker-down: ## Stop all services
	@echo "$(BLUE)Stopping services...$(NC)"
	docker-compose down

docker-logs: ## View logs from all services
	docker-compose logs -f

docker-restart: ## Restart all services
	@echo "$(BLUE)Restarting services...$(NC)"
	docker-compose restart

docker-clean: ## Clean Docker resources
	@echo "$(BLUE)Cleaning Docker resources...$(NC)"
	docker-compose down -v
	docker system prune -af

# Development
run-auth: ## Run auth service locally
	cd services/auth-service && poetry run uvicorn main:app --reload --port 8001

run-script: ## Run script service locally
	cd services/script-service && poetry run uvicorn main:app --reload --port 8002

run-execution: ## Run execution service locally
	cd services/execution-service && poetry run uvicorn main:app --reload --port 8003

run-secret: ## Run secret service locally
	cd services/secret-service && poetry run uvicorn main:app --reload --port 8004

# Monitoring & Logs
logs-auth: ## View auth service logs
	docker-compose logs -f auth-service

logs-script: ## View script service logs
	docker-compose logs -f script-service

logs-execution: ## View execution service logs
	docker-compose logs -f execution-service

logs-all: ## View all service logs
	docker-compose logs -f

health-check: ## Check health of all services
	@echo "$(BLUE)Checking service health...$(NC)"
	@curl -s http://localhost:8001/health || echo "$(RED)Auth service down$(NC)"
	@curl -s http://localhost:8002/health || echo "$(RED)Script service down$(NC)"
	@curl -s http://localhost:8003/health || echo "$(RED)Execution service down$(NC)"
	@curl -s http://localhost:8004/health || echo "$(RED)Secret service down$(NC)"

# Code Analysis
complexity: ## Check code complexity
	@echo "$(BLUE)Analyzing code complexity...$(NC)"
	poetry run radon cc . -a -nb

duplicates: ## Find duplicate code
	@echo "$(BLUE)Finding duplicate code...$(NC)"
	poetry run pylint --disable=all --enable=duplicate-code .

coverage-report: ## Generate and open coverage report
	@echo "$(BLUE)Generating coverage report...$(NC)"
	poetry run pytest --cov=. --cov-report=html
	open htmlcov/index.html

# Documentation
docs-build: ## Build documentation
	@echo "$(BLUE)Building documentation...$(NC)"
	cd docs && make html

docs-serve: ## Serve documentation locally
	@echo "$(BLUE)Serving documentation...$(NC)"
	cd docs/_build/html && python -m http.server 8000

# Cleanup
clean: ## Clean temporary files
	@echo "$(BLUE)Cleaning temporary files...$(NC)"
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf dist/
	rm -rf build/

clean-all: clean docker-clean ## Clean everything including Docker

# CI/CD
ci-test: ## Run CI test pipeline
	@echo "$(BLUE)Running CI test pipeline...$(NC)"
	make lint
	make security
	make test-cov

ci-build: ## Run CI build pipeline
	@echo "$(BLUE)Running CI build pipeline...$(NC)"
	make docker-build

ci-deploy: ## Run CI deploy pipeline (staging)
	@echo "$(BLUE)Deploying to staging...$(NC)"
	# Add deployment commands here

# Performance Testing
load-test: ## Run load tests with Locust
	@echo "$(BLUE)Running load tests...$(NC)"
	poetry run locust -f tests/performance/locustfile.py

# Secrets Management
generate-secrets: ## Generate secure secrets for .env
	@echo "$(BLUE)Generating secure secrets...$(NC)"
	@echo "SECRET_KEY=$$(openssl rand -hex 32)"
	@echo "ENCRYPTION_KEY=$$(openssl rand -hex 32)"
	@echo "DATABASE_PASSWORD=$$(openssl rand -base64 32)"

# Version Management
version: ## Show current version
	@poetry version

bump-patch: ## Bump patch version
	poetry version patch

bump-minor: ## Bump minor version
	poetry version minor

bump-major: ## Bump major version
	poetry version major

# Quick Commands
quick-start: install docker-up ## Quick start for new developers
	@echo "$(GREEN)OpsCraft is ready!$(NC)"
	@echo "API: http://localhost:8080"
	@echo "Docs: make docs-serve"

validate: format lint security test ## Validate all code before commit
	@echo "$(GREEN)All checks passed!$(NC)"
